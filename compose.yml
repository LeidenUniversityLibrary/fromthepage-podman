# version: "3.8"
services:
  fromthepage:
    # build:
    #   dockerfile: Containerfile
    #   context: .
    image: docker.io/bencomp/fromthepage:production
    platform: "linux/amd64"
    secrets:
    - db_host
    - db_name
    - db_user
    - db_password
    - app_secret_key_base
    - devise_secret_key
    - devise_pepper
    - devise_stretches
    env_file:
    - path: ./local.env
      required: false
    environment:
    - RAILS_ENV=development
    depends_on:
    - "mysql"
    ports:
    - "3000:3000"
    volumes:
      - fromthepage_config:/home/fromthepage/config
      - fromthepage_public:/home/fromthepage/public
    restart: always

  mysql:
    image: mysql:5.7
    platform: "linux/amd64"
    environment:
    - MYSQL_RANDOM_ROOT_PASSWORD=yes
    - MYSQL_USER_FILE=/run/secrets/db_user
    - MYSQL_PASSWORD_FILE=/run/secrets/db_password
    - MYSQL_DATABASE_FILE=/run/secrets/db_name
    secrets:
    - db_name
    - db_user
    - db_password
    volumes:
    - fromthepage_mysql_data:/var/lib/mysql
    - ./data:/docker-entrypoint-initdb.d
    restart: always

volumes:
  fromthepage_mysql_data:
  fromthepage_config:
  fromthepage_public:

secrets:
  db_host:
    file: ./secrets/db_host.txt
  db_name:
    file: ./secrets/db_name.txt
  db_user:
    file: ./secrets/db_user.txt
  db_password:
    file: ./secrets/db_password.txt
  app_secret_key_base:
    file: ./secrets/app_secret_key_base.txt
  devise_secret_key:
    file: ./secrets/devise_secret_key.txt
  devise_pepper:
    file: ./secrets/devise_pepper.txt
  devise_stretches:
    file: ./secrets/devise_stretches.txt
